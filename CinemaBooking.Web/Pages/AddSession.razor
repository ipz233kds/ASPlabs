@page "/sessions/add"
@using CinemaBooking.Shared.DTOs
@using CinemaBooking.Web.Services
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject AuthService AuthService

<h3>Додати новий сеанс</h3>

@if (movies == null)
{
    <p><em>Завантаження фільмів...</em></p>
}
else
{
    <EditForm Model="@sessionModel" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label class="form-label">Фільм:</label>
            <InputSelect class="form-control" @bind-Value="sessionModel.MovieID">
                <option value="0">-- Виберіть фільм --</option>
                @foreach (var movie in movies)
                {
                    <option value="@movie.MovieID">@movie.Title</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => sessionModel.MovieID)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Зал:</label>
            <InputText class="form-control" @bind-Value="sessionModel.Hall" />
            <ValidationMessage For="@(() => sessionModel.Hall)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Ціна:</label>
            <InputNumber class="form-control" @bind-Value="sessionModel.Price" />
            <ValidationMessage For="@(() => sessionModel.Price)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Час сеансу:</label>
            <InputDate class="form-control" @bind-Value="sessionModel.SessionTime" />
            <ValidationMessage For="@(() => sessionModel.SessionTime)" />
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        <button type="submit" class="btn btn-primary">Зберегти</button>
        <a href="/sessions" class="btn btn-link">Повернутися до списку</a>
    </EditForm>
}

@code {
    private CreateUpdateSessionDto sessionModel = new() { SessionTime = DateTime.Now };
    private MovieDto[]? movies;
    private HttpClient? Http;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        Http = HttpClientFactory.CreateClient("MyApi");
        movies = await Http.GetFromJsonAsync<MovieDto[]>("api/movies");
    }

    private async Task HandleValidSubmit()
    {
        if (Http == null) return;
        errorMessage = null;

        try
        {
            AuthService.SetAuthHeader(Http);

            var response = await Http.PostAsJsonAsync("api/sessions", sessionModel);

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/sessions");
            }
            else
            {
                errorMessage = "Помилка 401: Ви не авторизовані.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Виникла помилка: {ex.Message}";
        }
    }
}