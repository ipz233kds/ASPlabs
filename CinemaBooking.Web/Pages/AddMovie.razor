@page "/movies/add"
@using CinemaBooking.Shared.DTOs
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@using CinemaBooking.Web.Services
@inject AuthService AuthService

<h3>Додати новий фільм</h3>

<EditForm Model="@movieModel" OnValidSubmit="@HandleValidSubmit">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <label class="form-label">Назва:</label>
        <InputText class="form-control" @bind-Value="movieModel.Title" />
        <ValidationMessage For="@(() => movieModel.Title)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Жанр:</label>
        <InputText class="form-control" @bind-Value="movieModel.Genre" />
        <ValidationMessage For="@(() => movieModel.Genre)" />
    </div>

    <div class="mb-3">
        <label class="form-label">Опис:</label>
        <InputTextArea class="form-control" @bind-Value="movieModel.Description" />
        <ValidationMessage For="@(() => movieModel.Description)" />
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <button type="submit" class="btn btn-primary">Зберегти</button>
    <a href="/movies" class="btn btn-link">Повернутися до списку</a>
</EditForm>

@code {
    private CreateUpdateMovieDto movieModel = new();
    private HttpClient? Http;
    private string? errorMessage;

    protected override void OnInitialized()
    {
        Http = HttpClientFactory.CreateClient("MyApi");
    }

    private async Task HandleValidSubmit()
    {
        if (Http == null) return;
        errorMessage = null;

        try
        {
            AuthService.SetAuthHeader(Http);

            var response = await Http.PostAsJsonAsync("api/movies", movieModel);

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/movies");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                errorMessage = "Помилка 401: Ви не авторизовані. Можливо, потрібно увійти.";
            }
            else
            {
                errorMessage = $"Помилка збереження: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Виникла помилка: {ex.Message}";
        }
    }
}