@page "/sessions/edit/{SessionId:long}"
@using CinemaBooking.Shared.DTOs
@using CinemaBooking.Web.Services
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject AuthService AuthService

<h3>Редагувати сеанс</h3>

@if (sessionModel == null || movies == null || halls == null) // ⬅️ Оновлено
{
    <p><em>Завантаження даних...</em></p>
}
else
{
    <EditForm Model="@sessionModel" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label class="form-label">Фільм:</label>
            <InputSelect class="form-select" @bind-Value="sessionModel.MovieID">
                <option value="0">-- Виберіть фільм --</option>
                @foreach (var movie in movies)
                {
                    <option value="@movie.MovieID">@movie.Title</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => sessionModel.MovieID)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Зал:</label>
            <InputSelect class="form-select" @bind-Value="sessionModel.HallID">
                <option value="0">-- Виберіть зал --</option>
                @foreach (var hall in halls)
                {
                    <option value="@hall.HallID">@hall.Name</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => sessionModel.HallID)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Ціна:</label>
            <InputNumber class="form-control" @bind-Value="sessionModel.Price" />
            <ValidationMessage For="@(() => sessionModel.Price)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Час сеансу:</label>
            <InputDate type="InputDateType.DateTimeLocal" class="form-control" @bind-Value="sessionModel.SessionTime" />
            <ValidationMessage For="@(() => sessionModel.SessionTime)" />
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        <button type="submit" class="btn btn-primary">Оновити</button>
        <a href="/sessions" class="btn btn-link">Повернутися до списку</a>
    </EditForm>
}

@code {
    [Parameter]
    public long SessionId { get; set; }

    private CreateUpdateSessionDto? sessionModel;
    private MovieDto[]? movies;
    private HallDto[]? halls;

    private HttpClient? Http;
    private string? errorMessage;

    // ⛔️ ВИДАЛІТЬ ЦЕЙ РЯДОК (АБО ПЕРЕКОНАЙТЕСЬ, ЩО ЙОГО НЕМАЄ)
    // [Inject]
    // private IHttpClientFactory HttpClientFactory { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // 'HttpClientFactory' (з верхнього @inject) буде доступний тут
        Http = HttpClientFactory.CreateClient("MyApi");
        try
        {
            movies = await Http.GetFromJsonAsync<MovieDto[]>("api/movies");
            halls = await Http.GetFromJsonAsync<HallDto[]>("api/halls");
            var sessionDto = await Http.GetFromJsonAsync<MovieSessionDto>($"api/sessions/{SessionId}");

            if (sessionDto != null && halls != null)
            {
                sessionModel = new CreateUpdateSessionDto
                    {
                        HallID = halls.FirstOrDefault(h => h.Name == sessionDto.Hall)?.HallID ?? 0,
                        Price = sessionDto.Price,
                        SessionTime = sessionDto.SessionTime,
                        MovieID = sessionDto.MovieID ?? 0
                    };
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Не вдалося завантажити дані: {ex.Message}";
        }
    }

    private async Task HandleValidSubmit()
    {
        if (Http == null || sessionModel == null) return;
        errorMessage = null;

        try
        {
            AuthService.SetAuthHeader(Http);
            var response = await Http.PutAsJsonAsync($"api/sessions/{SessionId}", sessionModel);

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/sessions");
            }
            else
            {
                errorMessage = $"Помилка оновлення: {await response.Content.ReadAsStringAsync()}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Виникла помилка: {ex.Message}";
        }
    }
}