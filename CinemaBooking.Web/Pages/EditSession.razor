@page "/sessions/edit/{SessionId:long}"
@using CinemaBooking.Shared.DTOs
@using CinemaBooking.Web.Services
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Navigation
@inject AuthService AuthService

<h3>Редагувати сеанс</h3>

@if (sessionModel == null || movies == null)
{
    <p><em>Завантаження даних...</em></p>
}
else
{
    <EditForm Model="@sessionModel" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label class="form-label">Фільм:</label>
            <InputSelect class="form-control" @bind-Value="sessionModel.MovieID">
                <option value="0">-- Виберіть фільм --</option>
                @foreach (var movie in movies)
                {
                    <option value="@movie.MovieID">@movie.Title</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => sessionModel.MovieID)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Зал:</label>
            <InputText class="form-control" @bind-Value="sessionModel.Hall" />
            <ValidationMessage For="@(() => sessionModel.Hall)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Ціна:</label>
            <InputNumber class="form-control" @bind-Value="sessionModel.Price" />
            <ValidationMessage For="@(() => sessionModel.Price)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Час сеансу:</label>
            <InputDate class="form-control" @bind-Value="sessionModel.SessionTime" />
            <ValidationMessage For="@(() => sessionModel.SessionTime)" />
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        <button type="submit" class="btn btn-primary">Оновити</button>
        <a href="/sessions" class="btn btn-link">Повернутися до списку</a>
    </EditForm>
}

@code {
    [Parameter]
    public long SessionId { get; set; }
    private CreateUpdateSessionDto? sessionModel;
    private MovieDto[]? movies;
    private HttpClient? Http;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        Http = HttpClientFactory.CreateClient("MyApi");
        movies = await Http.GetFromJsonAsync<MovieDto[]>("api/movies");
        var sessionDto = await Http.GetFromJsonAsync<MovieSessionDto>($"api/sessions/{SessionId}");

        if (sessionDto != null)
        {
            sessionModel = new CreateUpdateSessionDto
                {
                    Hall = sessionDto.Hall,
                    Price = sessionDto.Price,
                    SessionTime = sessionDto.SessionTime,
                    MovieID = sessionDto.MovieID ?? 0
                };
        }
    }

    private async Task HandleValidSubmit()
    {
        if (Http == null || sessionModel == null) return;
        errorMessage = null;

        try
        {
            AuthService.SetAuthHeader(Http);

            var response = await Http.PutAsJsonAsync($"api/sessions/{SessionId}", sessionModel);

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/sessions");
            }
            else
            {
                errorMessage = "Помилка 401: Ви не авторизовані.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Виникла помилка: {ex.Message}";
        }
    }
}